var Layers=function(e){"use strict";var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(e,n)};function n(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}function r(e,t,n,r){var o,i=arguments.length,s=i<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,n):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,n,r);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(i<3?o(s):i>3?o(t,n,s):o(t,n))||s);return i>3&&s&&Object.defineProperty(t,n,s),s}function o(e,t,n,r){return new(n||(n=Promise))((function(o,i){function s(e){try{d(r.next(e))}catch(e){i(e)}}function a(e){try{d(r.throw(e))}catch(e){i(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}d((r=r.apply(e,t||[])).next())}))}function i(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=s.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}var s=function(){function e(){var e=this;this.listeners=[];var t,n,r,o,i=(t=function(){e.updateLocation()},n=0,o=0,function(){var e=this,i=arguments,s=function(){o=null,r||t.apply(e,i)},a=r&&!o;clearTimeout(o),o=setTimeout(s,n),a&&t.apply(e,i)});this.monkeyPatchHistory(),window.addEventListener("locationchange",i,!1),window.addEventListener("hashchange",i,!1),window.addEventListener("popstate",i,!1),window.addEventListener("pushState",i,!1),window.addEventListener("replaceState",i,!1)}return e.prototype.addListener=function(e){this.listeners.push(e)},e.prototype.destroy=function(){},e.prototype.monkeyPatchHistory=function(){var e=function(e){var t=history[e];return function(){var n=t.apply(this,arguments),r=new Event(e);return r.arguments=arguments,window.dispatchEvent(r),n}};history.pushState=e("pushState"),history.replaceState=e("replaceState")},e.prototype.updateLocation=function(){for(var e=this.getLocation(),t=0,n=this.listeners;t<n.length;t++){(0,n[t])(e)}},e.prototype.getLocation=function(){return window.location.href},e}(),a=function(){function e(){var e=this;this.listeners=[],document.querySelector("title")?this.setup():setInterval((function(){return e.setup()}),0)}return e.prototype.setup=function(){var e=this;this.observer=new MutationObserver((function(){return e.updateTitle()})),this.observer.observe(document.querySelector("title"),{subtree:!0,characterData:!0,childList:!0})},e.prototype.addListener=function(e){this.listeners.push(e)},e.prototype.destroy=function(){this.observer.disconnect()},e.prototype.updateTitle=function(){for(var e=this.getTitle(),t=0,n=this.listeners;t<n.length;t++){(0,n[t])(e)}},e.prototype.getTitle=function(){var e=document.querySelector("title");return null==e?void 0:e.innerText},e}(),d=function(){function e(){this.requestHandlers=new Map,this.ready=!1}return e.prototype.addRequestHandler=function(e,t){this.requestHandlers.set(e,t)},e.prototype.download=function(e){return o(this,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return[4,this.send("download",e)];case 1:return[2,t.sent()]}}))}))},e.prototype.setup=function(e){return o(this,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:if(this.ready)throw new Error("LayersSDK already set up!");return this.settings=e.settings,[4,this.send("setup",e)];case 1:if(!t.sent().success)throw new Error("Handshake failed!");return this.ready=!0,[2,{bridgeConnected:!0,platform:this.getPlatform()}]}}))}))},e}();function u(e){for(var t=0,n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t|=0}return t.toString(16)}var c=/^LAYERS:(-?[0-9a-f]+):(.+)$/,p=new(function(){function e(){}return e.prototype.serialize=function(e){var t=JSON.stringify(e);return"LAYERS:"+u(t)+":"+t},e.prototype.deserialize=function(e){var t=c.exec(e);if(!t)throw new Error("Malformed message");var n=t[1],r=t[2];if(u(r)!==n)throw new Error("Corrupted message");return JSON.parse(r)},e}()),l=function(e){function t(t){var n=e.call(this)||this;return n.pendingMessages={},n.targetWindow=t.targetWindow,n.targetOrigin=t.targetOrigin,n.version=t.version,n._bindedEventHandler=n._eventHandler.bind(n),window.addEventListener("message",n._bindedEventHandler,!1),n}return n(t,e),t.prototype.getPlatform=function(){return"iframe"},t.prototype.setup=function(t){return o(this,void 0,void 0,(function(){return i(this,(function(n){switch(n.label){case 0:if(window===this.targetWindow)throw new Error("Target must be a different Window");return[4,e.prototype.setup.call(this,t)];case 1:return[2,n.sent()]}}))}))},t.prototype.destroy=function(){this._bindedEventHandler&&(window.removeEventListener("message",this._bindedEventHandler,!1),this._bindedEventHandler=null),this.ready=!1},t.prototype.send=function(e,t,n){var r=this;return void 0===n&&(n=3e4),new Promise((function(o,i){var s=~~(Math.random()*(1<<30)),a=setTimeout((function(){i(new Error("Message "+s+" timed out!"))}),n);r.pendingMessages[s]={resolve:o,reject:i,timeoutId:a};var d={id:s,method:e,payload:t,version:r.version,type:"request"};try{r._postMessage(r.targetWindow,d,r.targetOrigin)}catch(e){return i(e)}}))},t.prototype.dispatch=function(e,t){if(this.requestHandlers.has(e))return this.requestHandlers.get(e)(t)},t.prototype._postMessage=function(e,t,n){var r=p.serialize(t);e.postMessage(r,n)},t.prototype._eventHandler=function(e){var t;try{t=p.deserialize(e.data)}catch(e){return}if(t.id)switch(t.type){case"response":return void this._handleResponseMessage(t);case"error":return void this._handleErrorMessage(t);case"request":return void this._handleRequestMessage(t,e.source);default:this.dispatch("error",new Error('Message received with unknown type "'+t.type+'"!'))}else this.dispatch("error",new Error("Message received without id!"))},t.prototype._handleResponseMessage=function(e){var t=e.id,n=e.payload;if(t in this.pendingMessages){var r=this.pendingMessages[t],o=r.resolve,i=r.timeoutId;clearTimeout(i),delete this.pendingMessages[t],o(n)}},t.prototype._handleErrorMessage=function(e){var t=e.id,n=new Error(e.payload);if(t in this.pendingMessages){var r=this.pendingMessages[t],o=r.reject,i=r.timeoutId;clearTimeout(i),delete this.pendingMessages[t],o(n)}},t.prototype._handleRequestMessage=function(e,t){var n=this,r=e.id,o=e.method,i=e.payload,s=this.dispatch(o,i);Promise.resolve(s).then((function(e){n._postMessage(t,{id:r,payload:e,version:n.version,type:"response"},"*")})).catch((function(e){n._postMessage(t,{id:r,payload:e.message,version:n.version,type:"error"},"*")}))},t}(d);var h,f=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return n(t,e),t.prototype.setup=function(e){return o(this,void 0,void 0,(function(){return i(this,(function(e){return this.ready=!1,[2,{bridgeConnected:!1}]}))}))},t.prototype.getPlatform=function(){return null},t.prototype.send=function(e,t,n){return o(this,void 0,void 0,(function(){return i(this,(function(t){throw new Error("App has no bridge to Layers "+e)}))}))},t.prototype.download=function(e){return o(this,void 0,void 0,(function(){var t,n,r;return i(this,(function(o){return t=e.url,n=e.filename,(r=document.createElement("a")).download=n,r.href=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),[2]}))}))},t}(d),y=function(e){function t(t){var n=e.call(this)||this;return n.pendingMessages={},n.version=t.version,n._bindedEventHandler=n._eventHandler.bind(n),window.addEventListener("layers:android",n._bindedEventHandler,!1),n}return n(t,e),t.prototype.getPlatform=function(){return"android"},t.prototype.destroy=function(){this._bindedEventHandler&&(window.removeEventListener("layers:android",this._bindedEventHandler,!1),this._bindedEventHandler=null),this.ready=!1},t.prototype.send=function(e,t,n){var r=this;return void 0===n&&(n=3e4),new Promise((function(o,i){var s=~~(Math.random()*(1<<30)),a=setTimeout((function(){i(new Error("Message "+s+" timed out!"))}),n);r.pendingMessages[s]={resolve:o,reject:i,timeoutId:a};var d={layers:!0,id:s,method:e,payload:t,version:r.version,type:"request",success:!0};try{r._postMessage(d)}catch(e){return i(e)}}))},t.prototype.dispatch=function(e,t){if(this.requestHandlers.has(e))return this.requestHandlers.get(e)(t)},t.prototype._postMessage=function(e){window.LayersAndroidBridge.send(JSON.stringify(e))},t.prototype._eventHandler=function(e){var t=e.detail;if(t.id)switch(t.type){case"response":return void this._handleResponseMessage(t);case"request":return void this._handleRequestMessage(t);default:this.dispatch("error",new Error('Message received with unknown type "'+t.type+'"!'))}else this.dispatch("error",new Error("Message received without id!"))},t.prototype._handleResponseMessage=function(e){var t=e.id,n=e.payload;if(t in this.pendingMessages){var r=this.pendingMessages[t],o=r.timeoutId;if(clearTimeout(o),delete this.pendingMessages[t],e.success)(0,r.resolve)(n);else(0,r.reject)(n)}},t.prototype._handleRequestMessage=function(e){var t=this,n=e.id,r=e.method,o=e.payload,i=this.dispatch(r,o);Promise.resolve(i).then((function(e){t._postMessage({layers:!0,id:n,payload:e,version:t.version,type:"response",success:!0})})).catch((function(e){t._postMessage({layers:!0,id:n,payload:e.message,version:t.version,type:"error",success:!1})}))},t}(d);var v=Symbol("IS_SDK_METHOD"),g=function(){return function(e,t,n){n.value[v]=!0}},w=function(){function e(){if(!window)throw new Error('Can not use Layers SDK without "window"');this.ready=!1,this.connected=!1,this.eventTarget=new EventTarget,this.locationWatcher=new s,this.titleWatcher=new a}return e.prototype.setup=function(e){return o(this,void 0,void 0,(function(){var t,n=this;return i(this,(function(r){switch(r.label){case 0:if(this.ready)throw new Error("LayersSDK already set up!");return this.settings=e,this.parentBridge=window.LayersAndroidBridge?new y({version:"0.1"}):window.frameElement?new l({targetOrigin:"*",targetWindow:window.parent,version:"0.1"}):new f,this.parentBridge.addRequestHandler("ping",(function(){return"pong"})),[4,this.parentBridge.setup({settings:e,location:this.locationWatcher.getLocation(),title:this.titleWatcher.getTitle()})];case 1:return t=r.sent(),this.ready=!0,this.eventTarget.dispatchEvent(new CustomEvent("ready",{detail:t})),t.bridgeConnected?(this.connected=!0,this.eventTarget.dispatchEvent(new CustomEvent("connected",{detail:t})),this.locationWatcher.addListener((function(e){n.update({location:e})})),this.titleWatcher.addListener((function(e){n.update({title:e})})),this.locationWatcher.updateLocation(),this.titleWatcher.updateTitle(),[2]):[2]}}))}))},e.prototype.handle=function(e,t){return o(this,void 0,void 0,(function(){var n;return i(this,(function(r){switch(r.label){case 0:if(!(n=this[e])||!n[v])throw new Error("Method "+e+" not found.");return[4,n.bind(this)(t)];case 1:return[2,r.sent()]}}))}))},e.prototype.onReady=function(e){this.eventTarget.addEventListener("ready",(function(t){e(t.detail)}))},e.prototype.onConnected=function(e){this.eventTarget.addEventListener("connected",(function(t){e(t.detail)}))},e.prototype.ping=function(){return this.parentBridge.send("ping")},e.prototype.update=function(e){this.parentBridge.ready&&this.parentBridge.send("update",e)},e.prototype.download=function(e){return o(this,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return[4,this.parentBridge.download(e)];case 1:return[2,t.sent()]}}))}))},e.prototype.createPost=function(e){return o(this,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return[4,this.parentBridge.send("createPost",e)];case 1:return[2,t.sent()]}}))}))},e.prototype.close=function(e){try{this.parentBridge.send("close",e)}catch(e){}try{window.close()}catch(e){}},e.prototype.createGroup=function(e){return o(this,void 0,void 0,(function(){return i(this,(function(t){switch(t.label){case 0:return[4,this.parentBridge.send("createGroup",e)];case 1:return[2,t.sent()]}}))}))},r([g()],e.prototype,"setup",null),r([g()],e.prototype,"onReady",null),r([g()],e.prototype,"onConnected",null),r([g()],e.prototype,"ping",null),r([g()],e.prototype,"update",null),r([g()],e.prototype,"download",null),r([g()],e.prototype,"createPost",null),r([g()],e.prototype,"close",null),r([g()],e.prototype,"createGroup",null),e}(),m=null===(h=window.Layers)||void 0===h?void 0:h.q,b=new w;if(window.LayersSettings&&b.setup(window.LayersSettings),window.Layers=function(e,t){return b.handle(e,t)},m)for(var E=0,M=m;E<M.length;E++){var _=M[E],L=_[0],S=_[1],H=_[2],T=_[3];b.handle(H,T).then(L).catch(S)}return e.LayersSDKCore=w,e.SdkMethod=g,e}({});
//# sourceMappingURL=app.js.map
