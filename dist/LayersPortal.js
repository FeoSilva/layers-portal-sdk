!function(){"use strict";var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};function t(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}function n(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{d(r.next(e))}catch(e){o(e)}}function a(e){try{d(r.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}d((r=r.apply(e,t||[])).next())}))}function r(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}}var i=function(){function e(){var e=this;this.listeners=[];var t,n,r,i,o=(t=function(){e.updateHistory()},n=0,i=0,function(){var e=this,o=arguments,s=function(){i=null,r||t.apply(e,o)},a=r&&!i;clearTimeout(i),i=setTimeout(s,n),a&&t.apply(e,o)});this.monkeyPatchHistory(),window.addEventListener("locationchange",o,!1),window.addEventListener("hashchange",o,!1),window.addEventListener("popstate",o,!1),window.addEventListener("pushState",o,!1),window.addEventListener("replaceState",o,!1)}return e.prototype.addListener=function(e){this.listeners.push(e)},e.prototype.destroy=function(){},e.prototype.monkeyPatchHistory=function(){var e=function(e){var t=history[e];return function(){var n=t.apply(this,arguments),r=new Event(e);return r.arguments=arguments,window.dispatchEvent(r),n}};history.pushState=e("pushState"),history.replaceState=e("replaceState")},e.prototype.updateHistory=function(){for(var e,t=window.location.href,n=null===(e=null===window||void 0===window?void 0:window.history)||void 0===e?void 0:e.state,r=0,i=this.listeners;r<i.length;r++){(0,i[r])({url:t,state:n})}},e}(),o=function(){function e(){var e=this;this.listeners=[],document.querySelector("title")?this.setup():setTimeout((function(){return e.setup()}),0)}return e.prototype.setup=function(){var e=this;this.observer=new MutationObserver((function(){return e.updateTitle()}));var t=document.querySelector("title");t&&this.observer.observe(t,{subtree:!0,characterData:!0,childList:!0})},e.prototype.addListener=function(e){this.listeners.push(e)},e.prototype.destroy=function(){this.observer&&this.observer.disconnect()},e.prototype.updateTitle=function(){for(var e=this.getTitle(),t=0,n=this.listeners;t<n.length;t++){(0,n[t])(e)}},e.prototype.getTitle=function(){var e=document.querySelector("title");return null==e?void 0:e.innerText},e}(),s=function(){function e(){this.requestHandlers=new Map,this.ready=!1}return e.prototype.addRequestHandler=function(e,t){this.requestHandlers.set(e,t)},e.prototype.download=function(e){return n(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,this.send("download",e)];case 1:return[2,t.sent()]}}))}))},e.prototype.setup=function(e){return n(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:if(this.ready)throw new Error("LayersSDK already set up!");return this.options=e.options,[4,this.send("setup",e)];case 1:if(!t.sent().success)throw new Error("Handshake failed!");return this.ready=!0,[2,{bridgeConnected:!0,platform:this.getPlatform()}]}}))}))},e}();function a(e){for(var t=0,n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t|=0}return t.toString(16)}var d=/^LAYERS:(-?[0-9a-f]+):(.+)$/,u=new(function(){function e(){}return e.prototype.serialize=function(e){var t=JSON.stringify(e);return"LAYERS:"+a(t)+":"+t},e.prototype.deserialize=function(e){var t=d.exec(e);if(!t)throw new Error("Malformed message");var n=t[1],r=t[2];if(a(r)!==n)throw new Error("Corrupted message");return JSON.parse(r)},e}()),c=function(e){function i(t){var n=e.call(this)||this;return n.pendingMessages={},n.targetWindow=t.targetWindow,n.targetOrigin=t.targetOrigin,n.version="1.0.0",n._bindedEventHandler=n._eventHandler.bind(n),window.addEventListener("message",n._bindedEventHandler,!1),n}return t(i,e),i.prototype.getPlatform=function(){return"iframe"},i.prototype.setup=function(t){return n(this,void 0,void 0,(function(){return r(this,(function(n){switch(n.label){case 0:if(window===this.targetWindow)throw new Error("Target must be a different Window");return[4,e.prototype.setup.call(this,t)];case 1:return[2,n.sent()]}}))}))},i.prototype.destroy=function(){this._bindedEventHandler&&(window.removeEventListener("message",this._bindedEventHandler,!1),this._bindedEventHandler=null),this.ready=!1},i.prototype.send=function(e,t,n){var r=this;return void 0===n&&(n=3e4),new Promise((function(i,o){var s=~~(Math.random()*(1<<30)),a=setTimeout((function(){o(new Error("Message "+s+" timed out!"))}),n);r.pendingMessages[s]={resolve:i,reject:o,timeoutId:a};var d={id:s,method:e,payload:t,version:r.version,type:"request"};try{r._postMessage(r.targetWindow,d,r.targetOrigin)}catch(e){return o(e)}}))},i.prototype.dispatch=function(e,t){if(this.requestHandlers.has(e))return this.requestHandlers.get(e)(t)},i.prototype._postMessage=function(e,t,n){var r=u.serialize(t);e.postMessage(r,n)},i.prototype._eventHandler=function(e){var t;try{t=u.deserialize(e.data)}catch(e){return}if(t.id)switch(t.type){case"response":return void this._handleResponseMessage(t);case"error":return void this._handleErrorMessage(t);case"request":return void this._handleRequestMessage(t,e.source);default:this.dispatch("error",new Error('Message received with unknown type "'+t.type+'"!'))}else this.dispatch("error",new Error("Message received without id!"))},i.prototype._handleResponseMessage=function(e){var t=e.id,n=e.payload;if(t in this.pendingMessages){var r=this.pendingMessages[t],i=r.resolve,o=r.timeoutId;clearTimeout(o),delete this.pendingMessages[t],i(n)}},i.prototype._handleErrorMessage=function(e){var t=e.id,n=new Error(e.payload);if(t in this.pendingMessages){var r=this.pendingMessages[t],i=r.reject,o=r.timeoutId;clearTimeout(o),delete this.pendingMessages[t],i(n)}},i.prototype._handleRequestMessage=function(e,t){var n=this,r=e.id,i=e.method,o=e.payload,s=this.dispatch(i,o);Promise.resolve(s).then((function(e){n._postMessage(t,{id:r,payload:e,version:n.version,type:"response"},"*")})).catch((function(e){n._postMessage(t,{id:r,payload:e.message,version:n.version,type:"error"},"*")}))},i}(s);var p=function(e){function i(){return null!==e&&e.apply(this,arguments)||this}return t(i,e),i.prototype.setup=function(e){return n(this,void 0,void 0,(function(){return r(this,(function(e){return this.ready=!1,[2,{bridgeConnected:!1}]}))}))},i.prototype.getPlatform=function(){return null},i.prototype.send=function(e,t,i){return n(this,void 0,void 0,(function(){return r(this,(function(t){throw new Error("App has no bridge to Layers "+e)}))}))},i.prototype.download=function(e){return n(this,void 0,void 0,(function(){var t,n,i;return r(this,(function(r){return t=e.url,n=e.filename,(i=document.createElement("a")).download=n,i.href=t,document.body.appendChild(i),i.click(),document.body.removeChild(i),[2]}))}))},i}(s),l=function(e){function n(){var t=e.call(this)||this;return t.pendingMessages={},t.version="1.0.0",t._bindedEventHandler=t._eventHandler.bind(t),window.addEventListener("layers:android",t._bindedEventHandler,!1),t}return t(n,e),n.prototype.getPlatform=function(){return"android"},n.prototype.destroy=function(){this._bindedEventHandler&&(window.removeEventListener("layers:android",this._bindedEventHandler,!1),this._bindedEventHandler=null),this.ready=!1},n.prototype.send=function(e,t,n){var r=this;return void 0===n&&(n=3e4),new Promise((function(i,o){var s=~~(Math.random()*(1<<30)),a=setTimeout((function(){o(new Error("Message "+s+" timed out!"))}),n);r.pendingMessages[s]={resolve:i,reject:o,timeoutId:a};var d={layers:!0,id:s,method:e,payload:t,version:r.version,type:"request",success:!0};try{r._postMessage(d)}catch(e){return o(e)}}))},n.prototype.dispatch=function(e,t){if(this.requestHandlers.has(e))return this.requestHandlers.get(e)(t)},n.prototype._postMessage=function(e){window.LayersAndroidBridge.send(JSON.stringify(e))},n.prototype._eventHandler=function(e){var t=e.detail;if(t.id)switch(t.type){case"response":return void this._handleResponseMessage(t);case"request":return void this._handleRequestMessage(t);default:this.dispatch("error",new Error('Message received with unknown type "'+t.type+'"!'))}else this.dispatch("error",new Error("Message received without id!"))},n.prototype._handleResponseMessage=function(e){var t=e.id,n=e.payload;if(t in this.pendingMessages){var r=this.pendingMessages[t],i=r.timeoutId;if(clearTimeout(i),delete this.pendingMessages[t],e.success)(0,r.resolve)(n);else(0,r.reject)(n)}},n.prototype._handleRequestMessage=function(e){var t=this,n=e.id,r=e.method,i=e.payload,o=this.dispatch(r,i);Promise.resolve(o).then((function(e){t._postMessage({layers:!0,id:n,payload:e,version:t.version,type:"response",success:!0})})).catch((function(e){t._postMessage({layers:!0,id:n,payload:e.message,version:t.version,type:"error",success:!1})}))},n}(s);var h=function(e){function n(){var t=e.call(this)||this;return t.pendingMessages={},t.version="1.0.0",t._bindedEventHandler=t._eventHandler.bind(t),window.addEventListener("layers:ios",t._bindedEventHandler,!1),t}return t(n,e),n.prototype.getPlatform=function(){return"ios"},n.prototype.destroy=function(){this._bindedEventHandler&&(window.removeEventListener("layers:ios",this._bindedEventHandler,!1),this._bindedEventHandler=null),this.ready=!1},n.prototype.send=function(e,t,n){var r=this;return void 0===n&&(n=3e4),new Promise((function(i,o){var s=~~(Math.random()*(1<<30)),a=setTimeout((function(){o(new Error("Message "+s+" timed out!"))}),n);r.pendingMessages[s]={resolve:i,reject:o,timeoutId:a};var d={layers:!0,id:s,method:e,payload:t,version:r.version,type:"request",success:!0};try{r._postMessage(d)}catch(e){return o(e)}}))},n.prototype.dispatch=function(e,t){if(this.requestHandlers.has(e))return this.requestHandlers.get(e)(t)},n.prototype._postMessage=function(e){window.webkit.messageHandlers.LayersIosBridge.postMessage(e)},n.prototype._eventHandler=function(e){var t=e.detail;if(t.id)switch(t.type){case"response":return void this._handleResponseMessage(t);case"request":return void this._handleRequestMessage(t);default:this.dispatch("error",new Error('Message received with unknown type "'+t.type+'"!'))}else this.dispatch("error",new Error("Message received without id!"))},n.prototype._handleResponseMessage=function(e){var t=e.id,n=e.payload;if(t in this.pendingMessages){var r=this.pendingMessages[t],i=r.timeoutId;if(clearTimeout(i),delete this.pendingMessages[t],e.success)(0,r.resolve)(n);else(0,r.reject)(n)}},n.prototype._handleRequestMessage=function(e){var t=this,n=e.id,r=e.method,i=e.payload,o=this.dispatch(r,i);Promise.resolve(o).then((function(e){t._postMessage({layers:!0,id:n,payload:e,version:t.version,type:"response",success:!0})})).catch((function(e){t._postMessage({layers:!0,id:n,payload:e.message,version:t.version,type:"error",success:!1})}))},n}(s);window.LayersPortal=function(){var e,t,s,a,d=this,u=document.createElement("div"),f=new i,v=new o,y={setup:function(e){return n(this,void 0,void 0,(function(){var t=this;return r(this,(function(n){switch(n.label){case 0:if(this.ready)throw new Error("LayersPortalSDK already set up!");return this.options=e,(s=function(){var e,t;return window.LayersAndroidBridge?new l:(null===(t=null===(e=window.webkit)||void 0===e?void 0:e.messageHandlers)||void 0===t?void 0:t.LayersIosBridge)?new h:window.frameElement||window.parent!==window?new c({targetOrigin:"*",targetWindow:window.parent}):new p}()).addRequestHandler("ping",(function(){return"pong"})),[4,s.setup({options:e,url:window.location.href,state:null===history||void 0===history?void 0:history.state,title:v.getTitle()})];case 1:return a=n.sent(),this.ready=!0,u.dispatchEvent(new CustomEvent("ready",{detail:a})),a.bridgeConnected?(this.connected=!0,u.dispatchEvent(new CustomEvent("connected",{detail:a})),f.addListener((function(e){t("update",e)})),v.addListener((function(e){t("update",{title:e})})),f.updateHistory(),v.updateTitle(),[2]):[2]}}))}))},ping:function(){return s.send("ping")},getAccountToken:function(){return s.send("getAccountToken")},getCommunity:function(){return s.send("getCommunity")},update:function(e){return s.send("update",e)},download:function(e){return n(this,void 0,void 0,(function(){return r(this,(function(t){switch(t.label){case 0:return[4,s.download(e)];case 1:return[2,t.sent()]}}))}))},close:function(e){try{s.send("close",e)}catch(e){}try{window.close()}catch(e){}}},w=function(e,t){return n(d,void 0,void 0,(function(){var n;return r(this,(function(r){switch(r.label){case 0:if(!(n=y[e]))throw new Error("Method "+e+" not found.");return[4,n.bind(w)(t)];case 1:return[2,r.sent()]}}))}))};w.ready=!1,w.connected=!1,w.platform=this,w.on=function(e,t){u.addEventListener(e,(function(e){t(e.detail)}))};var g=null===(e=window.LayersPortal)||void 0===e?void 0:e.q;if(g)for(var m=0,M=g;m<M.length;m++){var E=M[m],b=E[0],_=E[1],H=E[2],L=E[3];w(H,L).then(b).catch(_)}var q=null===(t=window.LayersPortal)||void 0===t?void 0:t.eh;if(q)for(var P in q)for(var T=0,S=q[P];T<S.length;T++){var R=S[T];w.on(P,R)}return w}(),window.LayersPortalOptions&&window.LayersPortal("setup",window.LayersPortalOptions)}();
//# sourceMappingURL=LayersPortal.js.map
